name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  build:
    name: Build & Unit Tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Build
        run: go build -v ./...

      - name: Run unit tests
        run: go test -v ./...

  integration:
    name: Integration Tests
    runs-on: ubuntu-24.04
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pexpect pyte

      - name: Install Incus
        run: |
          # Add Zabbly repo for latest Incus
          sudo mkdir -p /etc/apt/keyrings/
          sudo curl -fsSL https://pkgs.zabbly.com/key.asc -o /etc/apt/keyrings/zabbly.asc
          sudo sh -c 'cat <<SOURCES > /etc/apt/sources.list.d/zabbly-incus-stable.sources
          Enabled: yes
          Types: deb
          URIs: https://pkgs.zabbly.com/incus/stable
          Suites: $(. /etc/os-release && echo ${VERSION_CODENAME})
          Components: main
          Architectures: $(dpkg --print-architecture)
          Signed-By: /etc/apt/keyrings/zabbly.asc
          SOURCES'

          sudo apt-get update
          sudo apt-get install -y incus

      - name: Initialize Incus
        run: |
          # Initialize Incus with default settings
          sudo incus admin init --auto

          # Add current user to incus-admin group
          sudo usermod -aG incus-admin $USER

          # Allow access without re-login by changing socket permissions
          sudo chmod 666 /var/lib/incus/unix.socket

      - name: Fix iptables for Incus networking
        run: |
          # Docker sets FORWARD policy to DROP which blocks Incus containers
          # Allow forwarding for Incus bridge
          sudo iptables -P FORWARD ACCEPT
          sudo iptables -I FORWARD -i incusbr0 -j ACCEPT
          sudo iptables -I FORWARD -o incusbr0 -j ACCEPT

          # Verify the rules
          echo "Current iptables FORWARD chain:"
          sudo iptables -L FORWARD -v -n

          # Test Incus network by launching a simple container
          echo "Testing Incus network connectivity..."
          incus launch images:alpine/edge network-test
          sleep 10
          incus exec network-test -- ping -c 3 archive.ubuntu.com || echo "Warning: Network test failed, but continuing..."
          incus delete -f network-test

      - name: Build COI binary
        run: |
          go build -o coi ./cmd/coi
          ./coi version

      - name: Cache COI image
        id: cache-coi-image
        uses: actions/cache@v4
        with:
          path: /tmp/coi-image.tar.gz
          key: ${{ runner.os }}-coi-image-${{ hashFiles('internal/image/**', 'testdata/fake-claude/**') }}

      - name: Restore COI image from cache
        if: steps.cache-coi-image.outputs.cache-hit == 'true'
        run: |
          echo "Restoring COI image from cache..."
          incus image import /tmp/coi-image.tar.gz --alias coi
          ./coi images

      - name: Build COI image
        if: steps.cache-coi-image.outputs.cache-hit != 'true'
        run: |
          echo "Building COI image (not cached)..."
          ./coi build
          ./coi images
          # Export image for caching
          incus image export coi /tmp/coi-image

      - name: Run integration tests
        run: |
          # Run ephemeral tests
          python -m pytest tests/shell/ephemeral/ -v --tb=short

          # Run persistent tests
          python -m pytest tests/shell/persistent/ -v --tb=short
        env:
          COI_BINARY: ./coi

      - name: Cleanup
        if: always()
        run: |
          ./coi kill --all --force || true
          ./coi clean --force || true
